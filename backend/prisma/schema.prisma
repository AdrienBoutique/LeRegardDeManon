generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum NotificationType {
  CONFIRMATION
  REMINDER
  CANCELLATION
  FOLLOW_UP
}

enum DiscountType {
  PERCENT
  FIXED
}

enum Role {
  ADMIN
  STAFF
}

model StaffMember {
  id                String             @id @default(cuid())
  firstName         String
  lastName          String
  email             String             @unique
  userId            String?            @unique
  phone             String?
  role              String
  isActive          Boolean            @default(true)
  isTrainee         Boolean            @default(false)
  colorHex          String             @default("#8C6A52")
  defaultDiscountPercent Int?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  user              User?              @relation(fields: [userId], references: [id])
  serviceLinks      ServiceStaff[]
  appointments      Appointment[]
  availabilityRules AvailabilityRule[]
  timeOffs          TimeOff[]
  notificationLogs  NotificationLog[]
}

model User {
  id                 String      @id @default(cuid())
  email              String      @unique
  passwordHash       String
  role               Role        @default(STAFF)
  isActive           Boolean     @default(true)
  mustChangePassword Boolean     @default(true)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  practitioner       StaffMember?
}

model Service {
  id           String         @id @default(cuid())
  name         String         @unique
  description  String
  durationMin  Int
  priceCents   Int
  isActive     Boolean        @default(true)
  colorHex     String?
  categoryId   String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  category     ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  serviceLinks ServiceStaff[]
  appointmentItems AppointmentItem[]
  promotionLinks PromotionService[]
  @@index([categoryId])
}

model Promotion {
  id               String             @id @default(cuid())
  title            String
  subtitle         String?
  description      String?
  discountType     DiscountType
  discountValueInt Int
  startAt          DateTime
  endAt            DateTime
  active           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  services         PromotionService[]

  @@index([active, startAt, endAt])
}

model PromotionService {
  id          String    @id @default(cuid())
  promotionId String
  serviceId   String
  promotion   Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  service     Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([promotionId, serviceId])
  @@index([promotionId])
  @@index([serviceId])
}

model ServiceCategory {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  services  Service[]
}

model ServiceStaff {
  id            String      @id @default(cuid())
  serviceId     String
  staffMemberId String
  priceCentsOverride Int?
  discountPercentOverride Int?
  createdAt     DateTime    @default(now())
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staffMember   StaffMember @relation(fields: [staffMemberId], references: [id], onDelete: Cascade)

  @@unique([serviceId, staffMemberId])
  @@index([staffMemberId])
  @@index([serviceId])
}

model Client {
  id               String            @id @default(cuid())
  firstName        String
  lastName         String
  email            String?           @unique
  phone            String?           @unique
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  appointments     Appointment[]
  notificationLogs NotificationLog[]
}

model Appointment {
  id               String            @id @default(cuid())
  clientId         String
  staffMemberId    String
  startsAt         DateTime
  endsAt           DateTime
  status           AppointmentStatus @default(PENDING)
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Restrict)
  staffMember      StaffMember       @relation(fields: [staffMemberId], references: [id], onDelete: Restrict)
  notificationLogs NotificationLog[]
  items            AppointmentItem[]

  @@index([staffMemberId, startsAt])
  @@index([clientId, startsAt])
}

model AppointmentItem {
  id            String      @id @default(cuid())
  appointmentId String
  serviceId     String
  order         Int
  durationMin   Int
  priceCents    Int
  createdAt     DateTime    @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: Restrict)

  @@index([appointmentId])
  @@index([serviceId])
}

model AvailabilityRule {
  id            String      @id @default(cuid())
  staffMemberId String
  dayOfWeek     Int
  startTime     String
  endTime       String
  isActive      Boolean     @default(true)
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  staffMember   StaffMember @relation(fields: [staffMemberId], references: [id], onDelete: Cascade)

  @@unique([staffMemberId, dayOfWeek])
  @@index([staffMemberId, dayOfWeek])
}

model InstituteAvailabilityRule {
  id        String   @id @default(cuid())
  dayOfWeek Int      @unique
  startTime String
  endTime   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayOfWeek])
}

model TimeOff {
  id            String      @id @default(cuid())
  staffMemberId String
  startsAt      DateTime
  endsAt        DateTime
  reason        String?
  isAllDay      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  staffMember   StaffMember @relation(fields: [staffMemberId], references: [id], onDelete: Cascade)

  @@index([staffMemberId, startsAt])
}

model NotificationLog {
  id            String           @id @default(cuid())
  appointmentId String?
  staffMemberId String?
  clientId      String?
  type          NotificationType
  channel       String
  recipient     String
  payload       Json?
  status        String           @default("SENT")
  errorMessage  String?
  sentAt        DateTime         @default(now())
  appointment   Appointment?     @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  staffMember   StaffMember?     @relation(fields: [staffMemberId], references: [id], onDelete: SetNull)
  client        Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([appointmentId])
  @@index([clientId])
  @@index([staffMemberId])
}

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model HomeContent {
  id        String   @id @default(cuid())
  slug      String   @unique
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
