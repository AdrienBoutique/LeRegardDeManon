<section class="wizard-shell">
  <div class="wizard-steps">
    <button type="button" class="step-pill" [class.active]="step() === 1" (click)="goToStep(1)">1. Creneau</button>
    <button type="button" class="step-pill" [class.active]="step() === 2" [disabled]="!canGoStep2()" (click)="goToStep(2)">
      2. Services
    </button>
    <button type="button" class="step-pill" [class.active]="step() === 3" [disabled]="!canGoStep3()" (click)="goToStep(3)">
      3. Cliente
    </button>
    <button type="button" class="step-pill" [class.active]="step() === 4" [disabled]="!canGoStep4()" (click)="goToStep(4)">
      4. Confirmation
    </button>
  </div>

  @if (step() === 1) {
    <section class="step-panel">
      <h3>Creneau</h3>
      <label>
        Praticienne
        <select [ngModel]="draft().practitionerId ?? ''" (ngModelChange)="setPractitioner($event)">
          <option value="">Choisir...</option>
          @for (person of practitioners(); track person.id) {
            <option [value]="person.id">{{ person.name }}</option>
          }
        </select>
      </label>

      <label>
        Date et heure
        <input type="datetime-local" [ngModel]="startAtInputValue()" (ngModelChange)="setStartAt($event)" />
      </label>

      @if (!draft().practitionerId) {
        <p class="hint">Choisissez une praticienne pour continuer.</p>
      }
      @if (draft().durationMin <= 0) {
        <p class="hint">La duree sera calculee automatiquement a l'etape Services.</p>
      } @else if (conflictLoading()) {
        <p class="hint">Verification des conflits...</p>
      } @else if (conflict()?.conflict) {
        <p class="error">{{ conflictLabel() }}</p>
      } @else {
        <p class="hint">Aucun conflit detecte.</p>
      }
    </section>
  }

  @if (step() === 2) {
    <section class="step-panel">
      <h3>Services</h3>
      <label>
        Rechercher un service
        <input
          [ngModel]="serviceQuery()"
          (ngModelChange)="serviceQuery.set($event)"
          placeholder="Ex: Brow lift"
        />
      </label>
      <div class="services-list">
        @for (item of filteredServices(); track item.serviceId) {
          <button
            type="button"
            class="service-item"
            [class.selected]="isServiceSelected(item.serviceId)"
            [class.is-disabled]="isServiceDisabled(item.serviceId)"
            [disabled]="isServiceDisabled(item.serviceId)"
            (click)="toggleService(item)"
          >
            <strong>{{ item.name }}</strong>
            <span>{{ item.durationMin }} min</span>
            <span>{{ formatMoney(item.price) }}</span>
          </button>
        }
      </div>
      @if (filteredServices().length === 0) {
        <p class="hint">Aucun service trouve.</p>
      }
      @if (maxAvailableDurationMin() !== null) {
        <p class="hint">Temps disponible pour ce creneau: {{ maxAvailableDurationMin() }} min.</p>
      }
      @if (!selectionFitsAvailability()) {
        <p class="error">La selection depasse le temps disponible. Retirez un soin ou changez le creneau.</p>
      }
      <div class="totals">
        <p><strong>Duree totale:</strong> {{ draft().durationMin }} min</p>
        <p><strong>Total:</strong> {{ formatMoney(draft().priceTotal) }}</p>
      </div>
    </section>
  }

  @if (step() === 3) {
    <section class="step-panel">
      <h3>Cliente</h3>
      <div class="mode-switch">
        <button type="button" class="btn btn-ghost" [class.mode-active]="clientMode() === 'existing'" (click)="switchClientMode('existing')">
          Cliente existante
        </button>
        <button type="button" class="btn btn-ghost" [class.mode-active]="clientMode() === 'new'" (click)="switchClientMode('new')">
          Nouvelle cliente
        </button>
      </div>

      @if (clientMode() === 'existing') {
        <label>
          Rechercher
          <input [ngModel]="clientQuery()" (ngModelChange)="clientQuery.set($event)" placeholder="Nom cliente" />
        </label>
        <div class="clients-list">
          @for (client of filteredClients(); track client.id) {
            <button type="button" class="client-item" [class.selected]="draft().clientId === client.id" (click)="chooseClient(client)">
              {{ client.firstName }} {{ client.lastName }}
            </button>
          }
        </div>
      } @else {
        <div class="client-form">
          <label>
            Prenom
            <input
              [ngModel]="draft().clientDraft?.firstName ?? ''"
              (ngModelChange)="updateClientDraft('firstName', $event)"
            />
          </label>
          <label>
            Nom
            <input
              [ngModel]="draft().clientDraft?.lastName ?? ''"
              (ngModelChange)="updateClientDraft('lastName', $event)"
            />
          </label>
          <label>
            Telephone
            <input
              [ngModel]="draft().clientDraft?.phone ?? ''"
              (ngModelChange)="updateClientDraft('phone', $event)"
            />
          </label>
          <label>
            Email
            <input
              [ngModel]="draft().clientDraft?.email ?? ''"
              (ngModelChange)="updateClientDraft('email', $event)"
            />
          </label>
        </div>
      }
    </section>
  }

  @if (step() === 4) {
    <section class="step-panel">
      <h3>Confirmation</h3>
      <div class="summary">
        <p><strong>Praticienne:</strong> {{ practitionerNameById(draft().practitionerId) }}</p>
        <p><strong>Date:</strong> {{ formatDateTime(draft().startAt) }}</p>
        <p><strong>Services:</strong> {{ selectedServicesLabel() }}</p>
        <p><strong>Duree:</strong> {{ draft().durationMin }} min</p>
        <p><strong>Total:</strong> {{ formatMoney(draft().priceTotal) }}</p>
        <p><strong>Statut:</strong> {{ statusLabel(draft().status) }}</p>
      </div>

      <label>
        Statut
        <select [ngModel]="draft().status" (ngModelChange)="updateStatus($event)">
          <option value="confirmed">Confirme</option>
          <option value="pending">En attente</option>
          <option value="blocked">Bloque</option>
        </select>
      </label>

      <label>
        Notes
        <textarea rows="3" [ngModel]="draft().notes ?? ''" (ngModelChange)="updateNotes($event)"></textarea>
      </label>
    </section>
  }

  @if (errorMessage()) {
    <p class="error">{{ errorMessage() }}</p>
  }

  <footer class="wizard-actions">
    <button type="button" class="btn btn-ghost" [disabled]="step() === 1" (click)="previousStep()">Retour</button>

    @if (step() < 4) {
      <button
        type="button"
        class="btn btn-primary"
        [disabled]="(step() === 1 && !canGoStep2()) || (step() === 2 && !canGoStep3()) || (step() === 3 && !canGoStep4())"
        (click)="nextStep()"
      >
        Suivant
      </button>
    } @else {
      <button type="button" class="btn btn-primary" [disabled]="saving() || !canSubmit()" (click)="save()">
        {{ saving() ? 'Enregistrement...' : mode() === 'create' ? 'Creer' : 'Enregistrer' }}
      </button>
    }
  </footer>
</section>
