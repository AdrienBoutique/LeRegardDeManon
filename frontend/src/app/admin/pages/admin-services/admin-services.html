<section class="admin-services stack">
  <header class="heading card">
    <div class="heading-top">
      <div>
        <h1>Gestion des services</h1>
        <p>Creer, modifier et desactiver les prestations visibles sur le site.</p>
      </div>
      <button type="button" class="btn btn-primary btn-add" (click)="openCreateModal()">Ajouter +</button>
    </div>
  </header>

  @if (errorMessage()) {
    <article class="card error-box">{{ errorMessage() }}</article>
  }

  <article class="card filter-card">
    <label class="filter-label">
      Trier par categorie
      <select [value]="selectedCategoryFilter()" (change)="setCategoryFilter($any($event.target).value)">
        <option value="all">Toutes les categories</option>
        @for (category of categories(); track category.id) {
          <option [value]="category.id">{{ category.name }}</option>
        }
      </select>
    </label>
  </article>

  @if (editingId()) {
    <article class="card form-card edit-card">
      <h2>Modifier le service</h2>
      <form class="stack" [formGroup]="editForm" (ngSubmit)="submitEdit()">
        <label>
          Nom
          <input type="text" formControlName="name" />
        </label>
        <label>
          Description
          <textarea rows="3" formControlName="description"></textarea>
        </label>
        <div class="grid two-cols">
          <label>
            Duree (min)
            <input type="number" formControlName="durationMin" />
          </label>
          <label>
            Prix (EUR)
            <input type="number" step="0.01" formControlName="priceEur" />
          </label>
        </div>
        <div class="category-row">
          <label>
            Categorie
            <select formControlName="categoryId">
              <option value="">Aucune</option>
              @for (category of categories(); track category.id) {
                <option [value]="category.id">{{ category.name }}</option>
              }
            </select>
          </label>
          <button type="button" class="btn btn-ghost btn-plus" [disabled]="saving()" (click)="addCategoryForEdit()">
            +
          </button>
        </div>
        @if (categoryCreateTarget() === 'edit') {
          <div class="category-create-inline">
            <input
              type="text"
              [value]="categoryDraft()"
              (input)="setCategoryDraft($any($event.target).value)"
              placeholder="Nom de la categorie"
            />
            <button type="button" class="btn btn-ghost" [disabled]="saving()" (click)="cancelCategoryCreate()">
              Annuler
            </button>
            <button type="button" class="btn btn-primary" [disabled]="saving()" (click)="confirmCategoryCreate()">
              Ajouter
            </button>
          </div>
        }
        <div class="color-row">
          <label class="color-label">
            Couleur (optionnel)
            <select formControlName="colorHex">
              <option value="">Auto</option>
              @if (editForm.controls.colorHex.value && !hasColorOption(editForm.controls.colorHex.value)) {
                <option [value]="editForm.controls.colorHex.value">
                  Couleur actuelle ({{ editForm.controls.colorHex.value }})
                </option>
              }
              @for (color of colorOptions; track color.hex) {
                <option [value]="color.hex">{{ color.label }} ({{ color.hex }})</option>
              }
            </select>
          </label>
          <span class="color-preview">
            <span class="color-dot" [style.background]="editForm.controls.colorHex.value || '#d7c5b7'"></span>
            {{ editForm.controls.colorHex.value || 'Auto' }}
          </span>
          <button type="button" class="btn btn-ghost btn-sm" (click)="setEditColorAuto()">Auto</button>
        </div>
        <label class="check-row">
          <input type="checkbox" formControlName="active" />
          Actif
        </label>
        <div class="actions">
          <button type="submit" class="btn btn-primary" [disabled]="saving()">Sauvegarder</button>
          <button type="button" class="btn btn-ghost" (click)="cancelEdit()">Annuler</button>
        </div>
      </form>
    </article>
  }

  <section class="services-list grid">
    @if (loading()) {
      <article class="card">Chargement...</article>
    }

    @for (service of filteredServices(); track service.id) {
      <article class="card service-item">
        <div class="top">
          <h3>
            <span class="color-dot" [style.background]="service.colorHex || '#d7c5b7'"></span>
            {{ service.name }}
          </h3>
          <span class="chip" [class.inactive]="!service.active">{{ service.active ? 'Actif' : 'Inactif' }}</span>
        </div>
        <p>{{ service.description }}</p>
        <p class="meta">{{ service.durationMin }} min - {{ formatPrice(service.priceCents) }}</p>
        <p class="muted">Categorie: {{ service.categoryName || 'Aucune' }}</p>
        <p class="muted color-line">
          Couleur:
          @if (service.colorHex) {
            <span class="color-dot" [style.background]="service.colorHex"></span>
          } @else {
            <span>Auto</span>
          }
        </p>
        <div class="actions">
          <button type="button" class="btn btn-ghost" (click)="startEdit(service)">Editer</button>
          <button type="button" class="btn btn-ghost" (click)="deleteService(service)">Supprimer</button>
        </div>
      </article>
    }

    @if (!loading() && filteredServices().length === 0) {
      <article class="card">Aucun service pour cette categorie.</article>
    }
  </section>

  @if (createModalOpen()) {
    <div class="modal-overlay" (click)="closeCreateModal()">
      <article class="card form-card modal-card" (click)="$event.stopPropagation()">
        <div class="modal-top">
          <h2>Nouveau service</h2>
          <button type="button" class="btn btn-ghost" (click)="closeCreateModal()">Fermer</button>
        </div>
        <form class="stack" [formGroup]="createForm" (ngSubmit)="submitCreate()">
          <label>
            Nom
            <input type="text" formControlName="name" />
          </label>
          <label>
            Description
            <textarea rows="3" formControlName="description"></textarea>
          </label>
          <div class="grid two-cols">
            <label>
              Duree (min)
              <input type="number" formControlName="durationMin" />
            </label>
            <label>
              Prix (EUR)
              <input type="number" step="0.01" formControlName="priceEur" />
            </label>
          </div>
          <div class="category-row">
            <label>
              Categorie
              <select formControlName="categoryId">
                <option value="">Aucune</option>
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </label>
            <button type="button" class="btn btn-ghost btn-plus" [disabled]="saving()" (click)="addCategoryForCreate()">
              +
            </button>
          </div>
          @if (categoryCreateTarget() === 'create') {
            <div class="category-create-inline">
              <input
                type="text"
                [value]="categoryDraft()"
                (input)="setCategoryDraft($any($event.target).value)"
                placeholder="Nom de la categorie"
              />
              <button type="button" class="btn btn-ghost" [disabled]="saving()" (click)="cancelCategoryCreate()">
                Annuler
              </button>
              <button type="button" class="btn btn-primary" [disabled]="saving()" (click)="confirmCategoryCreate()">
                Ajouter
              </button>
            </div>
          }
          <section class="category-management">
            <div class="category-management-head">
              <p class="category-management-title">Categories existantes</p>
              <button type="button" class="btn btn-ghost btn-sm" (click)="toggleCategoriesList()">
                {{ categoriesListExpanded() ? 'Masquer' : 'Afficher' }}
              </button>
            </div>
            @if (categoriesListExpanded()) {
              @if (categories().length === 0) {
                <p class="muted">Aucune categorie creee.</p>
              } @else {
                <ul class="category-list">
                  @for (category of categories(); track category.id) {
                    <li class="category-item">
                      <span>{{ category.name }}</span>
                      @if (pendingCategoryDeleteId() === category.id) {
                        <div class="category-delete-confirm">
                          <button type="button" class="btn btn-ghost btn-sm" [disabled]="saving()" (click)="cancelCategoryDelete()">
                            Annuler
                          </button>
                          <button type="button" class="btn btn-primary btn-sm" [disabled]="saving()" (click)="deleteCategory(category)">
                            Confirmer
                          </button>
                        </div>
                      } @else {
                        <button type="button" class="btn btn-ghost btn-sm" [disabled]="saving()" (click)="requestCategoryDelete(category.id)">
                          Supprimer
                        </button>
                      }
                    </li>
                  }
                </ul>
              }
            }
          </section>
          <div class="color-row">
            <label class="color-label">
              Couleur (optionnel)
              <select formControlName="colorHex">
                <option value="">Auto</option>
                @if (createForm.controls.colorHex.value && !hasColorOption(createForm.controls.colorHex.value)) {
                  <option [value]="createForm.controls.colorHex.value">
                    Couleur actuelle
                  </option>
                }
                @for (color of colorOptions; track color.hex) {
                  <option [value]="color.hex">{{ color.label }}</option>
                }
              </select>
            </label>
            <span class="color-preview">
              <span class="color-dot" [style.background]="createForm.controls.colorHex.value || '#d7c5b7'"></span>
            </span>
            <button type="button" class="btn btn-ghost btn-sm" (click)="setCreateColorAuto()">Auto</button>
          </div>
          <label class="check-row">
            <input type="checkbox" formControlName="active" />
            Actif
          </label>
          <button type="submit" class="btn btn-primary" [disabled]="saving()">
            {{ saving() ? 'Enregistrement...' : 'Creer le service' }}
          </button>
        </form>
      </article>
    </div>
  }
</section>
